From 3e6ca196ba051c04e577cc58b321dcbbf5e959f9 Mon Sep 17 00:00:00 2001
From: Romanov Danila <pervokur@gmail.com>
Date: Sun, 1 Dec 2024 16:02:54 +0300
Subject: [PATCH] fw4: add offload_delay option to delay offload the datapath
 flows

fix anti-dpi (zapret, youtubeUnblock, etc)
Signed-off-by: Romanov Danila <pervokur@gmail.com>
---
 root/usr/share/firewall4/templates/ruleset.uc | 2 +-
 root/usr/share/ucode/fw4.uc                   | 1 +
 2 files changed, 2 insertions(+), 1 deletion(-)

Index: firewall4-2024.12.18~18fc0ead/root/usr/share/firewall4/templates/ruleset.uc
===================================================================
--- firewall4-2024.12.18~18fc0ead.orig/root/usr/share/firewall4/templates/ruleset.uc
+++ firewall4-2024.12.18~18fc0ead/root/usr/share/firewall4/templates/ruleset.uc
@@ -135,7 +135,7 @@ table inet fw4 {
 		type filter hook forward priority filter; policy {{ fw4.forward_policy(true) }};
 
 {% if (length(flowtable_devices) > 0): %}
-		meta l4proto { tcp, udp } flow offload @ft;
+		meta l4proto { tcp, udp } {% if (fw4.default_option("offload_delay")): %}ct original packets > 30{% endif %} flow offload @ft;
 {% endif %}
 {% fw4.includes('chain-prepend', 'forward') %}
 		ct state vmap { established : accept, related : accept{% if (fw4.default_option("drop_invalid")): %}, invalid : drop{% endif %} } comment "!fw4: Handle forwarded flows"
Index: firewall4-2024.12.18~18fc0ead/root/usr/share/ucode/fw4.uc
===================================================================
--- firewall4-2024.12.18~18fc0ead.orig/root/usr/share/ucode/fw4.uc
+++ firewall4-2024.12.18~18fc0ead/root/usr/share/ucode/fw4.uc
@@ -1971,6 +1971,7 @@ return {
 			disable_ipv6: [ "bool", null, UNSUPPORTED ],
 			flow_offloading: [ "bool", "0" ],
 			flow_offloading_hw: [ "bool", "0" ],
+			offload_delay: [ "bool", "0" ],
 
 			auto_includes: [ "bool", "1" ]
 		});
